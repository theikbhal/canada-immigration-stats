<script>
const fullData = [
 {year:1976,val:222},{year:1977,val:237},{year:1978,val:245},{year:1979,val:262},
 {year:1980,val:199},{year:1981,val:128},{year:1982,val:121},{year:1983,val:89},
 {year:1984,val:88},{year:1985,val:84},{year:1986,val:99},{year:1987,val:152},
 {year:1988,val:161},{year:1989,val:191},{year:1990,val:216},{year:1991,val:230},
 {year:1992,val:255},{year:1993,val:256},{year:1994,val:224},{year:1995,val:212},
 {year:1996,val:226},{year:1997,val:224},{year:1998,val:230},{year:1999,val:240},
 {year:2000,val:250},{year:2001,val:255},{year:2002,val:260},{year:2003,val:265},
 {year:2004,val:270},{year:2005,val:265},{year:2006,val:260},{year:2007,val:255},
 {year:2008,val:250},{year:2009,val:245},{year:2010,val:250},{year:2011,val:260},
 {year:2012,val:265},{year:2013,val:270},{year:2014,val:275},{year:2015,val:280},
 {year:2016,val:300},{year:2017,val:320},{year:2018,val:330},{year:2019,val:340},
 {year:2020,val:185},{year:2021,val:405},{year:2022,val:430},{year:2023,val:470},
 {year:2024,val:500}
];

const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");
const tooltip = document.getElementById("tooltip");
const tableBody = document.getElementById("tableBody");

let currentRange = 49;
let visibleData = [];

function updateRange(range, btn) {
  currentRange = range;
  document.querySelectorAll(".controls button")
    .forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  draw();
}

function toggleTable() {
  const t = document.getElementById("tableCard");
  t.style.display = t.style.display === "none" ? "block" : "none";
}

function draw() {
  canvas.width = canvas.offsetWidth;
  canvas.height = 240;

  visibleData = fullData.slice(-currentRange);

  const pad = 30;
  const max = Math.max(...visibleData.map(d => d.val));
  const step = (canvas.width - pad * 2) / (visibleData.length - 1);

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.beginPath();
  ctx.strokeStyle = "#5bc0be";
  ctx.lineWidth = 2;

  visibleData.forEach((d, i) => {
    d.x = pad + i * step;
    d.y = canvas.height - pad - (d.val / max) * (canvas.height - pad * 2);
    i === 0 ? ctx.moveTo(d.x, d.y) : ctx.lineTo(d.x, d.y);
  });
  ctx.stroke();

  // year labels
  ctx.fillStyle = "#a9bcd0";
  ctx.font = "10px sans-serif";
  visibleData.forEach((d, i) => {
    if (currentRange <= 7 || i % Math.ceil(visibleData.length / 6) === 0) {
      ctx.fillText(d.year, d.x - 12, canvas.height - 10);
    }
  });

  // table
  tableBody.innerHTML = "";
  visibleData.forEach(d => {
    tableBody.innerHTML += `<tr><td>${d.year}</td><td>${d.val}</td></tr>`;
  });
}

function handlePointer(e) {
  const rect = canvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

  const hit = visibleData.find(d => Math.hypot(d.x - x, d.y - y) < 8);

  if (hit) {
    tooltip.style.display = "block";
    tooltip.style.left = hit.x + 12 + "px";
    tooltip.style.top = hit.y - 10 + "px";
    tooltip.innerHTML = `${hit.year}<br><b>${hit.val}k</b>`;
  } else {
    tooltip.style.display = "none";
  }
}

canvas.addEventListener("mousemove", handlePointer);
canvas.addEventListener("touchstart", handlePointer);
canvas.addEventListener("touchmove", handlePointer);
canvas.addEventListener("mouseleave", () => tooltip.style.display = "none");

window.addEventListener("resize", draw);
draw();
</script>
